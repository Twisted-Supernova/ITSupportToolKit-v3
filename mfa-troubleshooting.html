<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MFA/Conditional Access Troubleshooting - IT Support Toolkit</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">IT Support Toolkit</div>
            <button class="burger-menu" id="burgerMenu" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        <div class="nav-menu" id="navMenu">
            <a href="index.html">Home</a>
            
            <div class="nav-dropdown">
                <button class="nav-dropdown-btn">Generators ▾</button>
                <div class="nav-dropdown-content">
                    <a href="password-generator.html">Password Generator</a>
                    <a href="username-generator.html">Username Generator</a>
                </div>
            </div>

            <div class="nav-dropdown">
                <button class="nav-dropdown-btn">Network Tools ▾</button>
                <div class="nav-dropdown-content">
                    <a href="ip-lookup.html">IP Lookup</a>
                    <a href="port-reference.html">Port Reference</a>
                    <a href="mac-lookup.html">MAC Lookup</a>
                    <a href="dns-lookup.html">DNS Lookup</a>
                    <a href="whois-lookup.html">WHOIS Lookup</a>
                </div>
            </div>

            <div class="nav-dropdown">
                <button class="nav-dropdown-btn">Data Tools ▾</button>
                <div class="nav-dropdown-content">
                    <a href="hash-generator.html">Hash Generator</a>
                    <a href="json-formatter.html">JSON Formatter</a>
                    <a href="encoder-decoder.html">Encoder/Decoder</a>
                    <a href="timestamp-converter.html">Timestamp Converter</a>
                    <a href="o365-license-decoder.html">O365 License Decoder</a>
                </div>
            </div>

            <div class="nav-dropdown">
                <button class="nav-dropdown-btn">System Tools ▾</button>
                <div class="nav-dropdown-content">
                    <a href="error-lookup.html">Error Lookup</a>
                    <a href="ntfs-builder.html">NTFS Permission Builder</a>
                    <a href="firewall-builder.html">Firewall Rule Builder</a>
                    <a href="flowcharts.html">Troubleshooting Flowcharts</a>
                    <a href="mfa-troubleshooting.html" class="active">MFA/CA Troubleshooting</a>
                    <a href="remote-session-builder.html">Remote Session Builder</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="tool-header">
            <h1>MFA/Conditional Access Troubleshooting</h1>
            <p>Comprehensive guide for diagnosing and resolving MFA and Conditional Access issues</p>
        </div>

        <div class="tool-content">
            <div class="search-section">
                <input type="text" id="searchInput" placeholder="Search for issues, symptoms, or error codes..." class="search-input">
            </div>

            <div class="section-tabs">
                <button class="tab-btn active" data-tab="common-mfa">Common MFA Issues</button>
                <button class="tab-btn" data-tab="ca-policies">CA Policy Problems</button>
                <button class="tab-btn" data-tab="sign-in-logs">Sign-in Logs</button>
                <button class="tab-btn" data-tab="powershell">PowerShell Commands</button>
            </div>

            <!-- Common MFA Issues -->
            <div id="common-mfa" class="tab-content active">
                <div class="issue-card">
                    <h3>User Can't Receive MFA Code</h3>
                    <div class="symptoms">
                        <strong>Symptoms:</strong> User not receiving SMS/phone call, authentication app not showing codes
                    </div>
                    <div class="solution">
                        <strong>Solutions:</strong>
                        <ol>
                            <li>Verify phone number is correct in Azure AD</li>
                            <li>Check if number includes correct country code (+44 for UK)</li>
                            <li>Try alternative authentication methods</li>
                            <li>Clear MFA registration and re-register</li>
                        </ol>
                    </div>
                    <div class="command-box">
<pre>Get-MsolUser -UserPrincipalName user@domain.com | Select StrongAuthenticationMethods</pre>
                        <button class="copy-btn" onclick="copyText(this)">Copy</button>
                    </div>
                </div>

                <div class="issue-card">
                    <h3>MFA Prompting Too Frequently</h3>
                    <div class="symptoms">
                        <strong>Symptoms:</strong> User prompted for MFA multiple times per day
                    </div>
                    <div class="solution">
                        <strong>Solutions:</strong>
                        <ol>
                            <li>Check "Remember multi-factor authentication" setting (default 90 days)</li>
                            <li>Verify browser isn't blocking cookies</li>
                            <li>Check for conflicting Conditional Access policies</li>
                            <li>Review session controls in CA policies</li>
                        </ol>
                    </div>
                </div>

                <div class="issue-card">
                    <h3>User Locked Out - Lost MFA Device</h3>
                    <div class="symptoms">
                        <strong>Symptoms:</strong> User lost phone, can't complete MFA
                    </div>
                    <div class="solution">
                        <strong>Solutions:</strong>
                        <ol>
                            <li>Admin resets MFA registration</li>
                            <li>Use Temporary Access Pass (TAP)</li>
                            <li>Exclude user from MFA policy temporarily (if critical)</li>
                        </ol>
                    </div>
                    <div class="command-box">
<pre># Reset MFA registration
Set-MsolUser -UserPrincipalName user@domain.com -StrongAuthenticationMethods @()

# Create Temporary Access Pass
$properties = @{
    isUsableOnce = $true
    lifetimeInMinutes = 60
}
New-MgUserAuthenticationTemporaryAccessPassMethod -UserId user@domain.com -BodyParameter $properties</pre>
                        <button class="copy-btn" onclick="copyText(this)">Copy</button>
                    </div>
                </div>
            </div>

            <!-- CA Policies -->
            <div id="ca-policies" class="tab-content">
                <div class="issue-card">
                    <h3>User Blocked by CA Policy</h3>
                    <div class="symptoms">
                        <strong>Symptoms:</strong> "Access blocked", "Your sign-in was blocked" error
                    </div>
                    <div class="solution">
                        <strong>Troubleshooting Steps:</strong>
                        <ol>
                            <li>Check Azure AD Sign-in Logs for the failure</li>
                            <li>Identify which CA policy blocked the user</li>
                            <li>Review policy conditions: location, device state, risk level</li>
                            <li>Common causes: Unmanaged device, non-compliant device, blocked location</li>
                        </ol>
                    </div>
                </div>

                <div class="issue-card">
                    <h3>Compliant Device Not Recognized</h3>
                    <div class="symptoms">
                        <strong>Symptoms:</strong> Device is Intune compliant but CA policy says it's not
                    </div>
                    <div class="solution">
                        <strong>Troubleshooting:</strong>
                        <ol>
                            <li>Verify device compliance status in Intune</li>
                            <li>Check device registration in Azure AD</li>
                            <li>Confirm user is signed in with work account</li>
                            <li>Force device check-in/sync in Intune</li>
                        </ol>
                    </div>
                    <div class="command-box">
<pre>Get-MgDevice -Filter "displayName eq 'DeviceName'" | Select DisplayName, IsCompliant, TrustType</pre>
                        <button class="copy-btn" onclick="copyText(this)">Copy</button>
                    </div>
                </div>

                <div class="issue-card">
                    <h3>Legacy Authentication Blocking</h3>
                    <div class="symptoms">
                        <strong>Symptoms:</strong> Outlook won't connect, "Basic authentication" errors
                    </div>
                    <div class="solution">
                        <strong>Solutions:</strong>
                        <ol>
                            <li>Identify apps using legacy auth via Sign-in Logs</li>
                            <li>Update clients to modern authentication</li>
                            <li>Enable Modern Authentication on mailboxes</li>
                            <li>Use App Passwords for apps that can't support Modern Auth</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- Sign-in Logs -->
            <div id="sign-in-logs" class="tab-content">
                <div class="issue-card">
                    <h3>Common Error Codes</h3>
                    <ul class="error-list">
                        <li><strong>50058:</strong> Silent sign-in failed - user not signed in</li>
                        <li><strong>50074:</strong> Strong authentication required (MFA needed)</li>
                        <li><strong>50126:</strong> Invalid username or password</li>
                        <li><strong>50132:</strong> Password expired</li>
                        <li><strong>53003:</strong> Access blocked by Conditional Access</li>
                        <li><strong>65001:</strong> User or application lacks consent</li>
                    </ul>
                </div>

                <div class="issue-card">
                    <h3>Key Fields to Check in Sign-in Logs</h3>
                    <ul>
                        <li><strong>Status:</strong> Success, Failure, Interrupted</li>
                        <li><strong>Conditional Access:</strong> Which policies applied and result</li>
                        <li><strong>Authentication Details:</strong> MFA result, methods used</li>
                        <li><strong>Device Information:</strong> OS, browser, compliant status</li>
                        <li><strong>Location:</strong> IP address, country, city</li>
                        <li><strong>Error Code:</strong> Specific failure reason</li>
                    </ul>
                </div>
            </div>

            <!-- PowerShell Commands -->
            <div id="powershell" class="tab-content">
                <div class="issue-card">
                    <h3>Connect to Required Modules</h3>
                    <div class="command-box">
<pre># MSOnline (legacy but still useful for MFA)
Connect-MsolService

# Microsoft Graph (modern, preferred)
Connect-MgGraph -Scopes "User.Read.All", "Policy.Read.All", "AuditLog.Read.All"</pre>
                        <button class="copy-btn" onclick="copyText(this)">Copy</button>
                    </div>
                </div>

                <div class="issue-card">
                    <h3>Check User MFA Status</h3>
                    <div class="command-box">
<pre># Get MFA methods for specific user
Get-MsolUser -UserPrincipalName user@domain.com | Select StrongAuthenticationMethods

# Get all users and their MFA status
Get-MsolUser -All | Select DisplayName, UserPrincipalName, @{N="MFA Status";E={if($_.StrongAuthenticationRequirements){$_.StrongAuthenticationRequirements.State}else{"Disabled"}}}</pre>
                        <button class="copy-btn" onclick="copyText(this)">Copy</button>
                    </div>
                </div>

                <div class="issue-card">
                    <h3>List Conditional Access Policies</h3>
                    <div class="command-box">
<pre># List all CA policies
Get-MgIdentityConditionalAccessPolicy | Select DisplayName, State, CreatedDateTime

# Get specific policy details
Get-MgIdentityConditionalAccessPolicy -ConditionalAccessPolicyId "policy-id" | Format-List</pre>
                        <button class="copy-btn" onclick="copyText(this)">Copy</button>
                    </div>
                </div>

                <div class="issue-card">
                    <h3>Query Sign-in Logs</h3>
                    <div class="command-box">
<pre># Get recent failed sign-ins
Get-MgAuditLogSignIn -Filter "status/errorCode ne 0" -Top 50 | Select UserPrincipalName, CreatedDateTime, Status

# Get sign-ins for specific user
Get-MgAuditLogSignIn -Filter "userPrincipalName eq 'user@domain.com'" -Top 100 | Select CreatedDateTime, Status, AppDisplayName</pre>
                        <button class="copy-btn" onclick="copyText(this)">Copy</button>
                    </div>
                </div>

                <div class="issue-card">
                    <h3>Check Device Compliance</h3>
                    <div class="command-box">
<pre># Get specific device details
Get-MgDevice -Filter "displayName eq 'DeviceName'" | Select DisplayName, IsCompliant, TrustType

# Get all devices for a user
Get-MgUserRegisteredDevice -UserId user@domain.com | Select DisplayName, IsCompliant</pre>
                        <button class="copy-btn" onclick="copyText(this)">Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 IT Support Toolkit</p>
    </footer>

    <script src="script.js"></script>
    <script>
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabId = this.dataset.tab;
                
                // Remove active class from all tabs and contents
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                this.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Copy function
        function copyText(button) {
            const codeBlock = button.previousElementSibling;
            const text = codeBlock.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = 'Copy';
                }, 2000);
            });
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const issueCards = document.querySelectorAll('.issue-card');
            
            issueCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm) || searchTerm === '') {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
